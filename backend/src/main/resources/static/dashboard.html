<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Risk Engine POC</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; max-width: 560px; margin: 4rem auto; padding: 0 1rem; }
        h1 { font-size: 1.25rem; margin-bottom: 1rem; }
        button { padding: 0.6rem 1rem; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #1d4ed8; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        #result { margin-top: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }
        #result h2 { font-size: 1rem; margin: 0 0 0.5rem 0; }
        #result p { margin: 0.25rem 0; font-size: 0.875rem; }
        .score { font-weight: 600; font-size: 1.25rem; }
        .decision-ALLOW { color: #059669; }
        .decision-MFA { color: #d97706; }
        .decision-TERMINATE { color: #b91c1c; }
    </style>
</head>
<body>
    <h1>Risk Engine POC – Dashboard</h1>
    <p>Session: <span id="sessionInfo">—</span> <a href="login.html">Logout</a></p>
    <button id="evaluateBtn">Evaluate Risk</button>
    <div id="result" hidden>
        <h2>Result</h2>
        <p>Risk score: <span id="riskScore" class="score">—</span></p>
        <p>Decision: <span id="decision">—</span></p>
        <p>Device signature: <code id="deviceSignature">—</code></p>
    </div>
    <p id="error" style="color: #b91c1c; margin-top: 0.5rem; font-size: 0.875rem;"></p>

    <script src="risk-agent.js"></script>
    <script>
        var API_BASE = (function () {
            var o = window.location.origin;
            if (o === 'http://localhost:8080' || o === 'http://127.0.0.1:8080') return '';
            return 'http://localhost:8080';
        })();
        var sessionId = sessionStorage.getItem('sessionId');
        var userId = sessionStorage.getItem('userId');
        if (!sessionId || !userId) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('sessionInfo').textContent = sessionId.slice(0, 8) + '…';
        }

        var evaluateBtn = document.getElementById('evaluateBtn');
        var resultDiv = document.getElementById('result');
        var errorEl = document.getElementById('error');

        evaluateBtn.addEventListener('click', async function () {
            errorEl.textContent = '';
            resultDiv.hidden = true;
            evaluateBtn.disabled = true;
            try {
                var payload = window.RiskAgent ? window.RiskAgent.captureAndBuildPayload(sessionId, userId) : null;
                if (!payload) { throw new Error('RiskAgent not loaded.'); }
                var res = await fetch(API_BASE + '/risk/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Evaluate failed: ' + res.status);
                var data = await res.json();
                document.getElementById('riskScore').textContent = data.riskScore;
                var decisionEl = document.getElementById('decision');
                decisionEl.textContent = data.decision;
                decisionEl.className = 'decision-' + data.decision;
                document.getElementById('deviceSignature').textContent = data.deviceSignature || '—';
                resultDiv.hidden = false;
            } catch (err) {
                errorEl.textContent = err.message || 'Evaluation failed.';
            } finally {
                evaluateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
