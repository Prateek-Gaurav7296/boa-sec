<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Risk Engine POC</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; max-width: 560px; margin: 4rem auto; padding: 0 1rem; }
        h1 { font-size: 1.25rem; margin-bottom: 1rem; }
        button { padding: 0.6rem 1rem; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #1d4ed8; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        #result { margin-top: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }
        #result h2 { font-size: 1rem; margin: 0 0 0.5rem 0; }
        #result p { margin: 0.25rem 0; font-size: 0.875rem; }
        .score { font-weight: 600; font-size: 1.25rem; }
        .decision-ALLOW { color: #059669; }
        .decision-MFA { color: #d97706; }
        .decision-TERMINATE { color: #b91c1c; }
        .iframe-breakdown { margin-top: 0.5rem; padding: 0.5rem; background: #fff; border-radius: 4px; font-size: 0.8125rem; }
        .security-alert { margin-top: 0.75rem; padding: 0.75rem; background: #fee2e2; border: 1px solid #dc2626; border-radius: 6px; color: #991b1b; font-weight: 600; font-size: 0.875rem; }
        .security-alert.warning { background: #fffbeb; border-color: #f59e0b; color: #92400e; }
    </style>
</head>
<body>
    <h1>Risk Engine POC – Dashboard</h1>
    <p>Session: <span id="sessionInfo">—</span> <a href="login.html">Logout</a></p>
    <p><a href="demo-malicious.html">Demo: Page with suspicious iframes</a> – use this to test iframe detection and alerts.</p>
    <button id="evaluateBtn">Evaluate Risk</button>
    <div id="result" hidden>
        <h2>Result</h2>
        <p>Risk score: <span id="riskScore" class="score">—</span></p>
        <p>Decision: <span id="decision">—</span></p>
        <div id="iframeBreakdown" class="iframe-breakdown" hidden></div>
        <p>Device signature: <code id="deviceSignature">—</code></p>
        <div id="securityAlert" class="security-alert" hidden></div>
    </div>
    <p id="error" style="color: #b91c1c; margin-top: 0.5rem; font-size: 0.875rem;"></p>

    <script src="/config/risk-agent-config.js"></script>
    <script src="risk-agent.js"></script>
    <script>
        var API_BASE = (function () {
            var o = window.location.origin;
            if (o === 'http://localhost:8080' || o === 'http://127.0.0.1:8080') return '';
            return 'http://localhost:8080';
        })();
        var sessionId = sessionStorage.getItem('sessionId');
        var userId = sessionStorage.getItem('userId');
        if (!sessionId || !userId) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('sessionInfo').textContent = sessionId.slice(0, 8) + '…';
        }

        var evaluateBtn = document.getElementById('evaluateBtn');
        var resultDiv = document.getElementById('result');
        var errorEl = document.getElementById('error');
        var iframeBreakdownEl = document.getElementById('iframeBreakdown');
        var securityAlertEl = document.getElementById('securityAlert');

        function showAlert(data) {
            var iframe = data.iframeSignals || {};
            var total = iframe.total || 0;
            var suspicious = iframe.suspicious || 0;
            var hidden = iframe.hidden || 0;
            var offscreen = iframe.offscreen || 0;
            var crossOrigin = iframe.crossOrigin || 0;
            var notFromOrg = iframe.notFromOrg || 0;
            var pageNotFromOrg = !!data.pageOriginNotFromOrg;
            if (iframeBreakdownEl && (total > 0 || suspicious > 0 || pageNotFromOrg || data.suspiciousReferrer || data.referrerUrl)) {
                iframeBreakdownEl.hidden = false;
                var parts = ['Iframes: total=' + total + ', suspicious=' + suspicious];
                if (hidden) parts.push('hidden=' + hidden);
                if (offscreen) parts.push('off-screen=' + offscreen);
                if (crossOrigin) parts.push('cross-origin=' + crossOrigin);
                if (notFromOrg) parts.push('not from org=' + notFromOrg);
                if (pageNotFromOrg) parts.push('Page URL not from org');
                if (data.referrerUrl) parts.push('referrer=' + (data.referrerUrl.length > 40 ? data.referrerUrl.slice(0, 40) + '…' : data.referrerUrl));
                if (data.suspiciousReferrer) parts.push('Suspicious referrer');
                iframeBreakdownEl.textContent = parts.join(', ');
            } else if (iframeBreakdownEl && (data.suspiciousReferrer || data.referrerUrl)) {
                iframeBreakdownEl.hidden = false;
                iframeBreakdownEl.textContent = (data.suspiciousReferrer ? 'Suspicious referrer (not from org). ' : '') + (data.referrerUrl ? 'Referrer: ' + (data.referrerUrl.length > 50 ? data.referrerUrl.slice(0, 50) + '…' : data.referrerUrl) : '');
            } else if (iframeBreakdownEl) { iframeBreakdownEl.hidden = true; }
            securityAlertEl.hidden = true;
            if (data.decision === 'TERMINATE') {
                securityAlertEl.hidden = false;
                securityAlertEl.className = 'security-alert';
                securityAlertEl.textContent = 'Security alert: High risk. Session terminated.' + (pageNotFromOrg ? ' Page URL is not from the organization.' : '') + (notFromOrg ? ' ' + notFromOrg + ' iframe(s) from non-org URLs.' : '') + (data.suspiciousReferrer ? ' Referrer URL is not from the organization (possible phishing/malware redirect).' : '');
            } else if (data.decision === 'MFA' || suspicious > 0 || pageNotFromOrg || data.suspiciousReferrer) {
                securityAlertEl.hidden = false;
                securityAlertEl.className = 'security-alert warning';
                var msg = [];
                if (data.suspiciousReferrer) msg.push('Suspicious referrer (possible phishing/malware redirect).');
                if (pageNotFromOrg) msg.push('Page URL is not from the organization.');
                if (notFromOrg) msg.push(notFromOrg + ' iframe(s) from non-org URLs.');
                if (suspicious > 0) msg.push(suspicious + ' suspicious iframe(s) detected.');
                if (data.decision === 'MFA') msg.push('MFA required.');
                securityAlertEl.textContent = 'Security alert: ' + (msg.join(' ') || ('Risk: ' + data.riskScore));
            }
        }

        evaluateBtn.addEventListener('click', async function () {
            errorEl.textContent = '';
            resultDiv.hidden = true;
            if (securityAlertEl) securityAlertEl.hidden = true;
            if (iframeBreakdownEl) iframeBreakdownEl.hidden = true;
            evaluateBtn.disabled = true;
            try {
                var payload = window.RiskAgent ? await window.RiskAgent.captureAndBuildPayload(sessionId, userId) : null;
                if (!payload) { throw new Error('RiskAgent not loaded.'); }
                var res = await fetch(API_BASE + '/risk/collect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Evaluate failed: ' + res.status);
                var data = await res.json();
                document.getElementById('riskScore').textContent = data.riskScore;
                var decisionEl = document.getElementById('decision');
                decisionEl.textContent = data.decision;
                decisionEl.className = 'decision-' + data.decision;
                document.getElementById('deviceSignature').textContent = data.deviceSignature || '—';
                resultDiv.hidden = false;
                showAlert(data);
            } catch (err) {
                errorEl.textContent = err.message || 'Evaluation failed.';
            } finally {
                evaluateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
